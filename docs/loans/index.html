<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-08-22 Fri 10:00 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=1024, initial-scale=1" />
<title>Fortran Finance</title>
<meta name="author" content="Mitch Richling" />
<meta name="description" content="Documentation for loan examples in the Fortran Finance repository." />
<meta name="keywords" content="finance fortran monte carlo inflation cashflow time value of money tvm percentages taxes stock market" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<style>body { width: 95%; margin: 2% auto; font-size: 18px; line-height: 1.4em; font-family: Georgia, serif; color: black; background-color: white; }</style>
<style>body { min-width: 500px; max-width: 1024px; }</style>
<style>h1,h2,h3,h4,h5,h6 { color: #A5573E; line-height: 1em; font-family: Helvetica, sans-serif; }</style>
<style>h1,h2,h3 { line-height: 1.4em; }</style>
<style>h1.title { font-size: 3em; }</style>
<style>.subtitle { font-size: 0.6em; }</style>
<style>h4,h5,h6 { font-size: 1em; }</style>
<style>.org-src-container { border: 1px solid #ccc; box-shadow: 3px 3px 3px #eee; font-family: Lucida Console, monospace; font-size: 80%; margin: 0px; padding: 0px 0px; position: relative; }</style>
<style>.org-src-container>pre { line-height: 1.2em; padding-top: 1.5em; margin: 0.5em; background-color: #404040; color: white; overflow: auto; }</style>
<style>.org-src-container>pre:before { display: block; position: absolute; background-color: #b3b3b3; top: 0; right: 0; padding: 0 0.2em 0 0.4em; border-bottom-left-radius: 8px; border: 0; color: white; font-size: 100%; font-family: Helvetica, sans-serif;}</style>
<style>pre.example { white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -o-pre-wrap; font-family: Lucida Console, monospace; font-size: 80%; background: #404040; color: white; display: block; padding: 0em; border: 2px solid black; }</style>
<style>blockquote { margin-bottom: 0.5em; padding: 0.5em; background-color: #FFF8DC; border-left: 2px solid #A5573E; border-left-color: rgb(255, 228, 102); display: block; margin-block-start: 1em; margin-block-end: 1em; margin-inline-start: 5em; margin-inline-end: 5em; } </style>
<style>#content { max-width: 60em; }</style>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://richmit.github.io/FortranFinance/index.html"> UP </a>
 |
 <a accesskey="H" href="https://github.com/richmit/FortranFinance"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Fortran Finance
<br />
<span class="subtitle">Loan Amortization</span>
</h1>
<table border="2 solid #ccc" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" align="center">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right"><b>Author:</b></td>
<td class="org-left"><i>Mitch Richling</i></td>
</tr>

<tr>
<td class="org-right"><b>Updated:</b></td>
<td class="org-left"><i>2025-08-22 10:00:36</i></td>
</tr>

<tr>
<td class="org-right"><b>Generated:</b></td>
<td class="org-left"><i>2025-08-22 10:00:36</i></td>
</tr>
</tbody>
</table>
<p align="center">
Copyright &copy; 2025 Mitch Richling. All rights reserved.
</p>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgc9a5d06">1. <code>loan_level_payments.f90</code></a></li>
<li><a href="#org7b1ba6e">2. <code>loan_geometric_payments.f90</code></a></li>
<li><a href="#org4fa988c">3. <code>loan_up_down_payments.f90</code></a></li>
</ul>
</div>
</div>
<div id="outline-container-orgc9a5d06" class="outline-2">
<h2 id="orgc9a5d06"><span class="section-number-2">1.</span> <code>loan_level_payments.f90</code></h2>
<div class="outline-text-2" id="text-1">
<div class="org" id="org02e6da7">
<p>
The typical approach to solving loan problems is to equate the present value of the principal with the present value of the
payment cashflow stream in a single equation and solve for the payment.  With only one principal payment occurring at the
beginning and a payment stream consisting of a level annuity certain, this is pretty simple.  Unfortunately things get much
more complex if the payment structure (for principal or repayment) changes from this baseline.  These more difficult
situations can be easily handled by considering the problem as multiple cashflow streams.  In order to illustrate how to
approach such problems using a multiple cashflow methodology, this program applies the technique to solve the familiar
problem of the simple loan.
</p>

<p>
We can model a loan as a pair of parallel cashflows:
</p>
<ul class="org-ul">
<li>Money paid by the lender (i.e. the principal) &#x2013; a negative cash flow from the lender's perspective</li>
<li>Money paid to the lender (i.e. loan payments) &#x2013; a positive cash flow from the lender's perspective</li>
</ul>
<p>
These two cash flows should have equal magnitude PV &amp; FV, but of opposite sign.
</p>

</div>

<p>
Here is the Fortran code (<a href="https://github.com/richmit/FortranFinance/blob/main/loans/loan_level_payments.f90">loan_level_payments.f90</a>):
</p>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #00ffff;">program</span> <span style="color: #00fa9a; font-weight: bold;">loan_level_payments</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_config</span>, <span style="color: #00ffff;">only</span>: rk=&gt;mrfflrk, ik=&gt;mrfflik
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_tvm</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_var_sets</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_prt_sets</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_cashflows</span>
  <span style="color: #00ffff;">implicit</span> <span style="color: #63b8ff;">none</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> n  = 10</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> i  = 7</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_pv, a_fv, a_a, p_pv, p_fv</span>
  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> a_d, a_e, p_d</span>

  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> status</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> cfm(11,2), fvv(11),  pvv(11)</span>

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">First, we print out the term and interest.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"n: "</span>, n
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"i: "</span>, i

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we compute the PV &amp; FV of the principal cashflow.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  p_pv = -1000000
  p_d = 0
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">tvm_lump_sum_solve</span>(n, i, p_pv, p_fv, var_fv, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"tvm_lump_sum_solve status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Loan PV: "</span>, p_pv
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Loan FV: "</span>, p_fv

  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we compute the PV &amp; FV of the repayment cashflow stream.</span>
  a_pv = -p_pv
  a_d = 1
  a_e = 0
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">tvm_delayed_level_annuity_solve</span>(n, i, a_pv, a_fv, a_a, a_d, a_e, var_fv+var_a, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"tvm_level_annuity_solve status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity PV: "</span>, a_pv
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity FV: "</span>, a_fv
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity A: "</span>,  a_a

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Just for fun, let's create cashflow sequences for everything, and print it out.</span>

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">First the principal cashflow.  Note we use the variables we used with the TVM solver.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">make_cashflow_vector_delayed_lump</span>(cfm(:,1), p_pv, p_d, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"make_cashflow_vector_delayed_lump status: "</span>, status

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Next the repayment cashflow.  Note we use the variables we used with the TVM solver.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">make_cashflow_vector_delayed_level_annuity</span>(cfm(:,2), a_a, a_d, a_e, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"make_cashflow_vector_delayed_level_annuity status: "</span>, status

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we print it out.  Notice the PV &amp; FV of the combined cashflow series is zero.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">cashflow_matrix_pv_fv</span>(cfm, i, pvv, fvv, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"cashflow_matrix_pv_fv status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"cashflow_matrix_pv_fv Sum: "</span>,   <span style="color: #00ffff;">sum</span>(cfm)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"cashflow_matrix_pv_fv PV Sum: "</span>, <span style="color: #00ffff;">sum</span>(pvv)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"cashflow_matrix_pv_fv FV Sum: "</span>, <span style="color: #00ffff;">sum</span>(fvv)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)

  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">cashflow_matrix_pv_fv_print</span>(cfm, i, pvv, fvv, status, prt_ALL)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)

<span style="color: #00ffff;">end program</span> <span style="color: #00fa9a; font-weight: bold;">loan_level_payments</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org7b1ba6e" class="outline-2">
<h2 id="org7b1ba6e"><span class="section-number-2">2.</span> <code>loan_geometric_payments.f90</code></h2>
<div class="outline-text-2" id="text-2">
<div class="org" id="orgc20856a">
<p>
This program extends the example from loan_level_payments.f90 to geometric payments.  Not much changes in the flow except the
annuity type.
</p>

<p>
If you are curious about how such a loan might come about, then consider the following scenario:
</p>

<p>
A business needs a 1M load.  They wish to make annual payments, and to pay down the loan as quickly as possible.  At the end
of the year they can afford to pay 95K.  The business has been experiencing 11% revenue growth for the last 5 years with
projections showing that to continue.  Based on growth projections, they wish to increase loan payments by 10% per year.  We
wish to extend them the loan, and make 7%.
</p>

</div>

<p>
Here is the Fortran code (<a href="https://github.com/richmit/FortranFinance/blob/main/loans/loan_geometric_payments.f90">loan_geometric_payments.f90</a>):
</p>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #00ffff;">program</span> <span style="color: #00fa9a; font-weight: bold;">loan_geometric_payments</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_config</span>, <span style="color: #00ffff;">only</span>: rk=&gt;mrfflrk, ik=&gt;mrfflik
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_tvm</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_var_sets</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_prt_sets</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_cashflows</span>
  <span style="color: #00ffff;">implicit</span> <span style="color: #63b8ff;">none</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> n</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> i  = 7</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_pv = 1000000</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_fv</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_g = 10</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_a = 95000</span>
  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> a_d = 1</span>
  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> a_e = 0</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> p_pv = -1000000</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> p_fv</span>

  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> status</span>

  <span style="color: #63b8ff;">real</span>(kind=rk), <span style="color: #00ffff;">allocatable</span>    ::<span style="color: #7fffd4;"> cfm(:,:), fvv(:),  pvv(:)</span>

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">First we solve for the number of years and future value of our loan.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">tvm_delayed_geometric_annuity_solve</span>(n, i, a_g, a_pv, a_fv, a_a, a_d, a_e, var_n+var_fv, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"tvm_level_annuity_solve status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity n: "</span>, n
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity FV: "</span>, a_fv
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #fa8072;">"From this result we know the loan term needs to be just about 10 years."</span>

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Instead of using an odd term, we decide on an even 10 year term.</span>
  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">So we must copute the initial loan payment, and loan FV</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  n = <span style="color: #00ffff;">ceiling</span>(n)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">tvm_delayed_geometric_annuity_solve</span>(n, i, a_g, a_pv, a_fv, a_a, a_d, a_e, var_a+var_fv, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"tvm_level_annuity_solve status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity a: "</span>, a_a
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity FV: "</span>, a_fv

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Next we check our work by solving for the FV of the lump sum.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">tvm_lump_sum_solve</span>(n, i, p_pv, p_fv, var_fv, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"tvm_lump_sum_solve status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Loan FV: "</span>, p_fv

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Allocate space for our cashflow matrix and the PV/FV vectors.  We don't check for allocation errors. ;)</span>
  <span style="color: #00ffff;">allocate</span>(cfm(<span style="color: #00ffff;">nint</span>(n)+1,2))
  <span style="color: #00ffff;">allocate</span>(fvv(<span style="color: #00ffff;">nint</span>(n)+1))
  <span style="color: #00ffff;">allocate</span>(pvv(<span style="color: #00ffff;">nint</span>(n)+1))

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we populate a cashflow matrix with our two cashflows.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">make_cashflow_vector_delayed_lump</span>(cfm(:,1), p_pv, 0_ik, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"make_cashflow_vector_delayed_lump status: "</span>, status
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">make_cashflow_vector_delayed_geometric_annuity</span>(cfm(:,2), a_g, a_a, a_d, a_e, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"make_cashflow_vector_delayed_level_annuity status: "</span>, status

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">We can check our work by making sure our cashflows sum to zero.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">cashflow_matrix_pv_fv</span>(cfm, i, pvv, fvv, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"cashflow_matrix_pv_fv status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"cashflow_matrix_pv_fv PV Sum: "</span>, <span style="color: #00ffff;">sum</span>(pvv)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"cashflow_matrix_pv_fv FV Sum: "</span>, <span style="color: #00ffff;">sum</span>(fvv)

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Finally we an print out our cashflows.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">cashflow_matrix_pv_fv_print</span>(cfm, i, pvv, fvv, status, prt_ALL)

  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)

<span style="color: #00ffff;">end program</span> <span style="color: #00fa9a; font-weight: bold;">loan_geometric_payments</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4fa988c" class="outline-2">
<h2 id="org4fa988c"><span class="section-number-2">3.</span> <code>loan_up_down_payments.f90</code></h2>
<div class="outline-text-2" id="text-3">
<div class="org" id="org3f6b68f">
<p>
This program extends the examples from loan_level_payments.f90 and loan_geometric_payments.f90 to a unequal, non-standard
annuity designed to make payments round cent values.
</p>

<p>
One way to amortize a loan is to round all payments but the last one up to the nearest penny, and then adjust the last
payment lower to accommodate the difference &#x2013; this last payment is rounded DOWN to the nearest cent.  This insures that the
lender will not loose more than a fractional cent on the entire transaction, and the borrower don't pay more than the agreed
upon rate (this second condition is required by law in many jurisdictions).  Note this method is unsuitable for very long
term loans as it may shorten the overall term.
</p>

</div>

<p>
Here is the Fortran code (<a href="https://github.com/richmit/FortranFinance/blob/main/loans/loan_up_down_payments.f90">loan_up_down_payments.f90</a>):
</p>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #00ffff;">program</span> <span style="color: #00fa9a; font-weight: bold;">loan_level_payments</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_config</span>, <span style="color: #00ffff;">only</span>: rk=&gt;mrfflrk, ik=&gt;mrfflik
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_tvm</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_var_sets</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_prt_sets</span>
  <span style="color: #00ffff;">use</span> <span style="color: #00fa9a; font-weight: bold;">mrffl_cashflows</span>
  <span style="color: #00ffff;">implicit</span> <span style="color: #63b8ff;">none</span>

  <span style="color: #63b8ff;">integer</span>, <span style="color: #00ffff;">parameter</span> ::<span style="color: #7fffd4;"> years = 10</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> n  = years</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> i  = 7</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_pv = 1000000</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_fv</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_a</span>
  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> a_d = 1</span>
  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> a_e = 0</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> p_pv = -1000000</span>
  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> p_fv</span>
  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> p_d = 0</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> a_final</span>

  <span style="color: #63b8ff;">integer</span>(kind=ik) ::<span style="color: #7fffd4;"> status</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)    ::<span style="color: #7fffd4;"> cfm(years+1,2), fvv(years+1),  pvv(years+1)</span>

  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"n: "</span>, n
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"i: "</span>, i

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">First we find the PV &amp; FV for the principal.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">tvm_lump_sum_solve</span>(n, i, p_pv, p_fv, var_fv, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"tvm_lump_sum_solve status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Loan PV: "</span>, p_pv
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Loan FV: "</span>, p_fv

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we solve for the payment (a in the annuity) and the fv</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">tvm_delayed_level_annuity_solve</span>(n, i, a_pv, a_fv, a_a, a_d, a_e, var_fv+var_a, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"tvm_level_annuity_solve status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity PV: "</span>, a_pv
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity FV: "</span>, a_fv
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Annuity A: "</span>,  a_a

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we round a_a UP to the nearest cent.</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  a_a = <span style="color: #00ffff;">ceiling</span>(100*a_a)
  a_a = a_a / 100
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Rounded Up Annuity A: "</span>,  a_a

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we find PV &amp; FV for an annuity with the rounded payment that ends one period early</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">tvm_delayed_level_annuity_solve</span>(n, i, a_pv, a_fv, a_a, a_d, a_e+1_ik, var_fv+var_pv, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"tvm_level_annuity_solve status: "</span>, status
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Rounded (n-1) Annuity PV: "</span>, a_pv
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Rounded (n-1) Annuity FV: "</span>, a_fv

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">The final payment needs to be the difference between the principal FV and the rounded annuity FV</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  a_final = <span style="color: #00ffff;">floor</span>(-(p_fv+a_fv)*100)
  a_final = a_final / 100
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,f15.4)"</span>, <span style="color: #fa8072;">"Final Payment: "</span>,  a_final

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we construct the cashflows so we can print a nice table</span>

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">We start with the principal</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">make_cashflow_vector_delayed_lump</span>(cfm(:,1), p_pv, p_d, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"make_cashflow_vector_delayed_lump status: "</span>, status

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Next we add the rounded up</span>
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">make_cashflow_vector_delayed_level_annuity</span>(cfm(:,2), a_a, a_d, a_e+1_ik, status)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a60,i15)"</span>, <span style="color: #fa8072;">"make_cashflow_vector_delayed_level_annuity status: "</span>, status

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Finally we add the last payment</span>
  cfm(years+1, 2) = a_final

  <span style="color: #ffa500;">! </span><span style="color: #ff7f24;">Now we print the cashflow</span>
  <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">cashflow_matrix_pv_fv_print</span>(cfm, i, pvv, fvv, status, prt_ALL)
  <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">"(a)"</span>, <span style="color: #00ffff;">repeat</span>(<span style="color: #fa8072;">"="</span>, 111)

<span style="color: #00ffff;">end program</span> <span style="color: #00fa9a; font-weight: bold;">loan_level_payments</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
</div>
</body>
</html>
